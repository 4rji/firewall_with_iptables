#!/usr/bin/env bash
set -euo pipefail

# Simple interactive iptables rule builder/applier.
# Works with iptables classic (requires root).

# Colors
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
CYAN="\033[1;36m"
RESET="\033[0m"

IPT=(iptables)
if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  echo "Nota: iptables requiere root. Usare sudo para ejecutar." >&2
  IPT=(sudo iptables)
fi

prompt() {
  local label="$1" default="${2-}"
  local input
  if [[ -n "$default" ]]; then
    read -r -p "$label [$default]: " input
    echo "${input:-$default}"
  else
    read -r -p "$label: " input
    echo "$input"
  fi
}

print_cmd() {
  echo -e "${YELLOW}Comando a ejecutar:${RESET}"
  printf '>> '
  printf '%q ' "$@"
  echo ""
}

run_cmd() {
  print_cmd "$@"
  "$@"
}

is_valid_port() {
  local p="$1"
  if [[ "$p" =~ ^[0-9]+$ ]]; then
    [[ "$p" -ge 1 && "$p" -le 65535 ]]
  elif [[ "$p" =~ ^[0-9]+:[0-9]+$ ]]; then
    local a b
    a="${p%%:*}"
    b="${p##*:}"
    [[ "$a" -ge 1 && "$a" -le 65535 && "$b" -ge 1 && "$b" -le 65535 && "$a" -le "$b" ]]
  else
    return 1
  fi
}

is_valid_ports_spec() {
  local spec="$1"
  local token
  local count=0

  [[ -n "$spec" ]] || return 1

  IFS=',' read -r -a tokens <<< "$spec"
  for token in "${tokens[@]}"; do
    token="${token//[[:space:]]/}"
    [[ -n "$token" ]] || return 1
    is_valid_port "$token" || return 1
    count=$((count + 1))
  done

  # iptables multiport admite hasta 15 puertos/rangos por regla.
  [[ "$count" -le 15 ]]
}

choose_action() {
  echo -e "${CYAN}Accion:${RESET}" >&2
  echo -e "  ${GREEN}1${RESET}) Permitir (ACCEPT)" >&2
  echo -e "  ${RED}2${RESET}) Bloquear (DROP)" >&2
  local choice
  while true; do
    choice=$(prompt "Accion (1-2) 1=Permitir, 2=Bloquear" "1")
    case "$choice" in
      1) echo "ACCEPT"; return 0 ;;
      2) echo "DROP"; return 0 ;;
      *) echo "Opcion invalida." ;;
    esac
  done
}

choose_chain() {
  echo -e "${CYAN}Direccion:${RESET}" >&2
  echo -e "  ${GREEN}1${RESET}) Entrante (INPUT)" >&2
  echo -e "  ${GREEN}2${RESET}) Saliente (OUTPUT)" >&2
  echo -e "  ${GREEN}3${RESET}) Reenvio (FORWARD)" >&2
  local choice
  while true; do
    choice=$(prompt "Direccion (1-3) 1=Entrante, 2=Saliente, 3=Reenvio" "1")
    case "$choice" in
      1) echo "INPUT"; return 0 ;;
      2) echo "OUTPUT"; return 0 ;;
      3) echo "FORWARD"; return 0 ;;
      *) echo "Opcion invalida." ;;
    esac
  done
}

choose_proto() {
  echo -e "${CYAN}Protocolo:${RESET}" >&2
  echo -e "  ${GREEN}1${RESET}) tcp" >&2
  echo -e "  ${GREEN}2${RESET}) udp" >&2
  echo -e "  ${GREEN}3${RESET}) icmp" >&2
  echo -e "  ${GREEN}4${RESET}) all (sin -p)" >&2
  local choice
  while true; do
    choice=$(prompt "Protocolo (1-4) 1=tcp, 2=udp, 3=icmp, 4=todos" "1")
    case "$choice" in
      1) echo "tcp"; return 0 ;;
      2) echo "udp"; return 0 ;;
      3) echo "icmp"; return 0 ;;
      4) echo "all"; return 0 ;;
      *) echo "Opcion invalida." ;;
    esac
  done
}

apply_rule() {
  local action chain proto port src dst inif outif

  action=$(choose_action)
  chain=$(choose_chain)
  proto=$(choose_proto)

  port=""
  if [[ "$proto" == "tcp" || "$proto" == "udp" ]]; then
    while true; do
      port=$(prompt "Puerto(s)/rango(s) (ej: 80, 22,1234,12411 o 1000:2000, o 'any')" "any")
      if [[ "$port" == "any" ]]; then
        port=""
        break
      fi
      if is_valid_ports_spec "$port"; then
        port="${port//[[:space:]]/}"
        break
      fi
      echo "Puerto(s) invalido(s). Usa coma para multiples y maximo 15 items."
    done
  fi

  src=$(prompt "IP/CIDR de origen (enter para omitir)" "")
  dst=$(prompt "IP/CIDR de destino (enter para omitir)" "")

  inif=""
  outif=""
  if [[ "$chain" == "INPUT" || "$chain" == "FORWARD" ]]; then
    inif=$(prompt "Interfaz de entrada (enter para omitir)" "")
  fi
  if [[ "$chain" == "OUTPUT" || "$chain" == "FORWARD" ]]; then
    outif=$(prompt "Interfaz de salida (enter para omitir)" "")
  fi

  local -a cmd
  cmd=("${IPT[@]}" -A "$chain")

  if [[ "$proto" != "all" ]]; then
    cmd+=(-p "$proto")
  fi
  if [[ -n "$port" ]]; then
    if [[ "$port" == *,* ]]; then
      cmd+=(-m multiport --dports "$port")
    else
      cmd+=(--dport "$port")
    fi
  fi
  if [[ -n "$src" ]]; then
    cmd+=(-s "$src")
  fi
  if [[ -n "$dst" ]]; then
    cmd+=(-d "$dst")
  fi
  if [[ -n "$inif" ]]; then
    cmd+=(-i "$inif")
  fi
  if [[ -n "$outif" ]]; then
    cmd+=(-o "$outif")
  fi

  cmd+=(-j "$action")

  echo ""
  print_cmd "${cmd[@]}"

  local confirm
  confirm=$(prompt "Aplicar regla? (s/N)" "N")
  case "$confirm" in
    s|S|si|SI)
      "${cmd[@]}"
      echo -e "${GREEN}Regla aplicada.${RESET}"
      ;;
    *)
      echo -e "${RED}Cancelado.${RESET}"
      ;;
  esac
}

main_menu() {
  while true; do
    echo ""
    echo -e "${BLUE}Firewall wizard (iptables)${RESET}"
    echo -e "  ${GREEN}1${RESET}) Crear y aplicar regla"
    echo -e "  ${GREEN}2${RESET}) Listar reglas actuales"
    echo -e "  ${GREEN}3${RESET}) Habilitar firewall (default DROP)"
    echo -e "  ${GREEN}4${RESET}) Deshabilitar firewall (default ACCEPT)"
    echo -e "  ${GREEN}5${RESET}) Modo agresivo (OUTPUT DROP + allowlist)"
    echo -e "  ${GREEN}6${RESET}) Modo internet (DNS + HTTP/HTTPS)"
    echo -e "  ${RED}7${RESET}) Salir"
    local choice
    choice=$(prompt "Menu (1-7) 1=Crear, 2=Listar, 3=Enable, 4=Disable, 5=Agresivo, 6=Internet, 7=Salir" "1")
    case "$choice" in
      1) apply_rule ;;
      2) run_cmd "${IPT[@]}" -L -n -v --line-numbers ;;
      3) enable_firewall ;;
      4) disable_firewall ;;
      5) aggressive_mode ;;
      6) internet_mode ;;
      7) exit 0 ;;
      *) echo "Opcion invalida." ;;
    esac
  done
}

enable_firewall() {
  echo ""
  echo -e "${YELLOW}Habilitar firewall:${RESET} INPUT=DROP, FORWARD=DROP, OUTPUT=ACCEPT"
  local confirm
  confirm=$(prompt "Confirmar? (s/N)" "N")
  case "$confirm" in
    s|S|si|SI)
      # Reglas base seguras
      run_cmd "${IPT[@]}" -C INPUT -i lo -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -i lo -j ACCEPT
      run_cmd "${IPT[@]}" -C INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
      run_cmd "${IPT[@]}" -C FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

      run_cmd "${IPT[@]}" -P INPUT DROP
      run_cmd "${IPT[@]}" -P FORWARD DROP
      run_cmd "${IPT[@]}" -P OUTPUT ACCEPT
      echo -e "${GREEN}Firewall habilitado.${RESET}"
      ;;
    *) echo -e "${RED}Cancelado.${RESET}" ;;
  esac
}

disable_firewall() {
  echo ""
  echo -e "${YELLOW}Deshabilitar firewall:${RESET} INPUT=ACCEPT, FORWARD=ACCEPT, OUTPUT=ACCEPT"
  local confirm
  confirm=$(prompt "Confirmar? (s/N)" "N")
  case "$confirm" in
    s|S|si|SI)
      run_cmd "${IPT[@]}" -P INPUT ACCEPT
      run_cmd "${IPT[@]}" -P FORWARD ACCEPT
      run_cmd "${IPT[@]}" -P OUTPUT ACCEPT
      echo -e "${GREEN}Firewall deshabilitado (politicas en ACCEPT).${RESET}"
      ;;
    *) echo -e "${RED}Cancelado.${RESET}" ;;
  esac
}

aggressive_mode() {
  echo ""
  echo -e "${YELLOW}Modo agresivo:${RESET} INPUT=DROP, FORWARD=DROP, OUTPUT=DROP"
  echo -e "${YELLOW}Solo se permitira trafico saliente con reglas OUTPUT explicitas.${RESET}"
  local confirm
  confirm=$(prompt "Confirmar modo agresivo? (s/N)" "N")
  case "$confirm" in
    s|S|si|SI)
      # Reglas base para no romper loopback y conexiones ya establecidas.
      run_cmd "${IPT[@]}" -C INPUT -i lo -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -i lo -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -o lo -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I OUTPUT -o lo -j ACCEPT
      run_cmd "${IPT[@]}" -C INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
      run_cmd "${IPT[@]}" -C FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

      run_cmd "${IPT[@]}" -P INPUT DROP
      run_cmd "${IPT[@]}" -P FORWARD DROP
      run_cmd "${IPT[@]}" -P OUTPUT DROP
      echo -e "${GREEN}Modo agresivo habilitado.${RESET}"
      ;;
    *) echo -e "${RED}Cancelado.${RESET}" ;;
  esac
}

internet_mode() {
  echo ""
  echo -e "${YELLOW}Modo internet:${RESET} INPUT=DROP, FORWARD=DROP, OUTPUT=DROP + allowlist web"
  echo -e "${YELLOW}Permite DNS (53 tcp/udp), HTTP (80/tcp), HTTPS (443/tcp+udp).${RESET}"
  local confirm
  confirm=$(prompt "Confirmar modo internet? (s/N)" "N")
  case "$confirm" in
    s|S|si|SI)
      # Base segura: loopback y trafico relacionado/establecido.
      run_cmd "${IPT[@]}" -C INPUT -i lo -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -i lo -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -o lo -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I OUTPUT -o lo -j ACCEPT
      run_cmd "${IPT[@]}" -C INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
      run_cmd "${IPT[@]}" -C FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

      # Allowlist saliente para internet.
      run_cmd "${IPT[@]}" -C OUTPUT -p udp --dport 53 -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -A OUTPUT -p udp --dport 53 -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -p tcp --dport 53 -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -A OUTPUT -p tcp --dport 53 -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -A OUTPUT -p tcp --dport 80 -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -p tcp --dport 443 -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -A OUTPUT -p tcp --dport 443 -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -p udp --dport 443 -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -A OUTPUT -p udp --dport 443 -j ACCEPT

      run_cmd "${IPT[@]}" -P INPUT DROP
      run_cmd "${IPT[@]}" -P FORWARD DROP
      run_cmd "${IPT[@]}" -P OUTPUT DROP
      echo -e "${GREEN}Modo internet habilitado.${RESET}"
      ;;
    *) echo -e "${RED}Cancelado.${RESET}" ;;
  esac
}

main_menu
