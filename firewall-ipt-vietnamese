#!/usr/bin/env bash
set -euo pipefail

# Simple interactive iptables rule builder/applier.
# Works with iptables classic (requires root).

# Colors
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
CYAN="\033[1;36m"
RESET="\033[0m"

IPT=(iptables)
if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  echo "Luu y: iptables can quyen root. Toi se dung sudo de chay lenh." >&2
  IPT=(sudo iptables)
fi

prompt() {
  local label="$1" default="${2-}"
  local input
  if [[ -n "$default" ]]; then
    read -r -p "$label [$default]: " input
    echo "${input:-$default}"
  else
    read -r -p "$label: " input
    echo "$input"
  fi
}

print_cmd() {
  echo -e "${YELLOW}Lenh se chay:${RESET}"
  printf '>> '
  printf '%q ' "$@"
  echo ""
}

run_cmd() {
  print_cmd "$@"
  "$@"
}

is_valid_port() {
  local p="$1"
  if [[ "$p" =~ ^[0-9]+$ ]]; then
    [[ "$p" -ge 1 && "$p" -le 65535 ]]
  elif [[ "$p" =~ ^[0-9]+:[0-9]+$ ]]; then
    local a b
    a="${p%%:*}"
    b="${p##*:}"
    [[ "$a" -ge 1 && "$a" -le 65535 && "$b" -ge 1 && "$b" -le 65535 && "$a" -le "$b" ]]
  else
    return 1
  fi
}

is_valid_ports_spec() {
  local spec="$1"
  local token
  local count=0

  [[ -n "$spec" ]] || return 1

  IFS=',' read -r -a tokens <<< "$spec"
  for token in "${tokens[@]}"; do
    token="${token//[[:space:]]/}"
    [[ -n "$token" ]] || return 1
    is_valid_port "$token" || return 1
    count=$((count + 1))
  done

  # iptables multiport ho tro toi da 15 cong/khoang cong moi rule.
  [[ "$count" -le 15 ]]
}

choose_action() {
  echo -e "${CYAN}Hanh dong:${RESET}" >&2
  echo -e "  ${GREEN}1${RESET}) Cho phep (ACCEPT)" >&2
  echo -e "  ${RED}2${RESET}) Chan (DROP)" >&2
  local choice
  while true; do
    choice=$(prompt "Hanh dong (1-2) 1=Cho phep, 2=Chan" "1")
    case "$choice" in
      1) echo "ACCEPT"; return 0 ;;
      2) echo "DROP"; return 0 ;;
      *) echo "Lua chon khong hop le." ;;
    esac
  done
}

choose_chain() {
  echo -e "${CYAN}Huong ket noi:${RESET}" >&2
  echo -e "  ${GREEN}1${RESET}) Vao (INPUT)" >&2
  echo -e "  ${GREEN}2${RESET}) Ra (OUTPUT)" >&2
  echo -e "  ${GREEN}3${RESET}) Chuyen tiep (FORWARD)" >&2
  local choice
  while true; do
    choice=$(prompt "Huong (1-3) 1=Vao, 2=Ra, 3=Chuyen tiep" "1")
    case "$choice" in
      1) echo "INPUT"; return 0 ;;
      2) echo "OUTPUT"; return 0 ;;
      3) echo "FORWARD"; return 0 ;;
      *) echo "Lua chon khong hop le." ;;
    esac
  done
}

choose_proto() {
  echo -e "${CYAN}Giao thuc:${RESET}" >&2
  echo -e "  ${GREEN}1${RESET}) tcp" >&2
  echo -e "  ${GREEN}2${RESET}) udp" >&2
  echo -e "  ${GREEN}3${RESET}) icmp" >&2
  echo -e "  ${GREEN}4${RESET}) all (khong dung -p)" >&2
  local choice
  while true; do
    choice=$(prompt "Giao thuc (1-4) 1=tcp, 2=udp, 3=icmp, 4=all" "1")
    case "$choice" in
      1) echo "tcp"; return 0 ;;
      2) echo "udp"; return 0 ;;
      3) echo "icmp"; return 0 ;;
      4) echo "all"; return 0 ;;
      *) echo "Lua chon khong hop le." ;;
    esac
  done
}

apply_rule() {
  local action chain proto port src dst inif outif

  action=$(choose_action)
  chain=$(choose_chain)
  proto=$(choose_proto)

  port=""
  if [[ "$proto" == "tcp" || "$proto" == "udp" ]]; then
    while true; do
      port=$(prompt "Cong/khoang cong (vi du: 80, 22,1234,12411 hoac 1000:2000, hoac 'any')" "any")
      if [[ "$port" == "any" ]]; then
        port=""
        break
      fi
      if is_valid_ports_spec "$port"; then
        port="${port//[[:space:]]/}"
        break
      fi
      echo "Cong khong hop le. Dung dau phay cho nhieu cong, toi da 15 muc."
    done
  fi

  src=$(prompt "IP/CIDR nguon (nhan Enter de bo qua)" "")
  dst=$(prompt "IP/CIDR dich (nhan Enter de bo qua)" "")

  inif=""
  outif=""
  if [[ "$chain" == "INPUT" || "$chain" == "FORWARD" ]]; then
    inif=$(prompt "Interface vao (nhan Enter de bo qua)" "")
  fi
  if [[ "$chain" == "OUTPUT" || "$chain" == "FORWARD" ]]; then
    outif=$(prompt "Interface ra (nhan Enter de bo qua)" "")
  fi

  local -a cmd
  cmd=("${IPT[@]}" -A "$chain")

  if [[ "$proto" != "all" ]]; then
    cmd+=(-p "$proto")
  fi
  if [[ -n "$port" ]]; then
    if [[ "$port" == *,* ]]; then
      cmd+=(-m multiport --dports "$port")
    else
      cmd+=(--dport "$port")
    fi
  fi
  if [[ -n "$src" ]]; then
    cmd+=(-s "$src")
  fi
  if [[ -n "$dst" ]]; then
    cmd+=(-d "$dst")
  fi
  if [[ -n "$inif" ]]; then
    cmd+=(-i "$inif")
  fi
  if [[ -n "$outif" ]]; then
    cmd+=(-o "$outif")
  fi

  cmd+=(-j "$action")

  echo ""
  print_cmd "${cmd[@]}"

  local confirm
  confirm=$(prompt "Ap dung rule? (y/N)" "N")
  case "$confirm" in
    y|Y|yes|YES|s|S|si|SI|c|C|co|CO)
      "${cmd[@]}"
      echo -e "${GREEN}Da ap dung rule.${RESET}"
      ;;
    *)
      echo -e "${RED}Da huy.${RESET}"
      ;;
  esac
}

main_menu() {
  while true; do
    echo ""
    echo -e "${BLUE}Firewall wizard (iptables)${RESET}"
    echo -e "  ${GREEN}1${RESET}) Tao va ap dung rule"
    echo -e "  ${GREEN}2${RESET}) Liet ke rule hien tai"
    echo -e "  ${GREEN}3${RESET}) Bat firewall (mac dinh DROP)"
    echo -e "  ${GREEN}4${RESET}) Tat firewall (mac dinh ACCEPT)"
    echo -e "  ${GREEN}5${RESET}) Che do manh (OUTPUT DROP + allowlist)"
    echo -e "  ${GREEN}6${RESET}) Che do Internet (DNS + HTTP/HTTPS)"
    echo -e "  ${GREEN}7${RESET}) Xoa rule theo so"
    echo -e "  ${RED}8${RESET}) Thoat"
    local choice
    choice=$(prompt "Menu (1-8) 1=Tao, 2=Liet ke, 3=Bat, 4=Tat, 5=Manh, 6=Internet, 7=Xoa, 8=Thoat" "1")
    case "$choice" in
      1) apply_rule ;;
      2) run_cmd "${IPT[@]}" -L -n -v --line-numbers ;;
      3) enable_firewall ;;
      4) disable_firewall ;;
      5) aggressive_mode ;;
      6) internet_mode ;;
      7) delete_rule ;;
      8) exit 0 ;;
      *) echo "Lua chon khong hop le." ;;
    esac
  done
}

enable_firewall() {
  echo ""
  echo -e "${YELLOW}Bat firewall:${RESET} INPUT=DROP, FORWARD=DROP, OUTPUT=ACCEPT"
  local confirm
  confirm=$(prompt "Xac nhan? (y/N)" "N")
  case "$confirm" in
    y|Y|yes|YES|s|S|si|SI|c|C|co|CO)
      # Rule co so an toan.
      run_cmd "${IPT[@]}" -C INPUT -i lo -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -i lo -j ACCEPT
      run_cmd "${IPT[@]}" -C INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
      run_cmd "${IPT[@]}" -C FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

      run_cmd "${IPT[@]}" -P INPUT DROP
      run_cmd "${IPT[@]}" -P FORWARD DROP
      run_cmd "${IPT[@]}" -P OUTPUT ACCEPT
      echo -e "${GREEN}Da bat firewall.${RESET}"
      ;;
    *) echo -e "${RED}Da huy.${RESET}" ;;
  esac
}

disable_firewall() {
  echo ""
  echo -e "${YELLOW}Tat firewall:${RESET} INPUT=ACCEPT, FORWARD=ACCEPT, OUTPUT=ACCEPT"
  local confirm
  confirm=$(prompt "Xac nhan? (y/N)" "N")
  case "$confirm" in
    y|Y|yes|YES|s|S|si|SI|c|C|co|CO)
      run_cmd "${IPT[@]}" -P INPUT ACCEPT
      run_cmd "${IPT[@]}" -P FORWARD ACCEPT
      run_cmd "${IPT[@]}" -P OUTPUT ACCEPT
      echo -e "${GREEN}Da tat firewall (policy dat ACCEPT).${RESET}"
      ;;
    *) echo -e "${RED}Da huy.${RESET}" ;;
  esac
}

aggressive_mode() {
  echo ""
  echo -e "${YELLOW}Che do manh:${RESET} INPUT=DROP, FORWARD=DROP, OUTPUT=DROP"
  echo -e "${YELLOW}Chi luong ra duoc cho phep ro rang trong OUTPUT moi duoc qua.${RESET}"
  local confirm
  confirm=$(prompt "Xac nhan che do manh? (y/N)" "N")
  case "$confirm" in
    y|Y|yes|YES|s|S|si|SI|c|C|co|CO)
      # Rule co so de giu loopback va ket noi ESTABLISHED/RELATED.
      run_cmd "${IPT[@]}" -C INPUT -i lo -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -i lo -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -o lo -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I OUTPUT -o lo -j ACCEPT
      run_cmd "${IPT[@]}" -C INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
      run_cmd "${IPT[@]}" -C FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

      run_cmd "${IPT[@]}" -P INPUT DROP
      run_cmd "${IPT[@]}" -P FORWARD DROP
      run_cmd "${IPT[@]}" -P OUTPUT DROP
      echo -e "${GREEN}Da bat che do manh.${RESET}"
      ;;
    *) echo -e "${RED}Da huy.${RESET}" ;;
  esac
}

internet_mode() {
  echo ""
  echo -e "${YELLOW}Che do Internet:${RESET} INPUT=DROP, FORWARD=DROP, OUTPUT=DROP + allowlist web"
  echo -e "${YELLOW}Cho phep DNS (53 tcp/udp), HTTP (80/tcp), HTTPS (443/tcp+udp).${RESET}"
  local confirm
  confirm=$(prompt "Xac nhan che do Internet? (y/N)" "N")
  case "$confirm" in
    y|Y|yes|YES|s|S|si|SI|c|C|co|CO)
      # Rule co so an toan: loopback va ESTABLISHED/RELATED.
      run_cmd "${IPT[@]}" -C INPUT -i lo -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -i lo -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -o lo -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I OUTPUT -o lo -j ACCEPT
      run_cmd "${IPT[@]}" -C INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
      run_cmd "${IPT[@]}" -C FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -I FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

      # Allowlist luong ra cho Internet.
      run_cmd "${IPT[@]}" -C OUTPUT -p udp --dport 53 -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -A OUTPUT -p udp --dport 53 -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -p tcp --dport 53 -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -A OUTPUT -p tcp --dport 53 -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -A OUTPUT -p tcp --dport 80 -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -p tcp --dport 443 -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -A OUTPUT -p tcp --dport 443 -j ACCEPT
      run_cmd "${IPT[@]}" -C OUTPUT -p udp --dport 443 -j ACCEPT 2>/dev/null || run_cmd "${IPT[@]}" -A OUTPUT -p udp --dport 443 -j ACCEPT

      run_cmd "${IPT[@]}" -P INPUT DROP
      run_cmd "${IPT[@]}" -P FORWARD DROP
      run_cmd "${IPT[@]}" -P OUTPUT DROP
      echo -e "${GREEN}Da bat che do Internet.${RESET}"
      ;;
    *) echo -e "${RED}Da huy.${RESET}" ;;
  esac
}

delete_rule() {
  echo ""
  echo -e "${YELLOW}Xoa rule theo so${RESET}"
  local chain rule_num confirm

  chain=$(choose_chain)

  echo ""
  echo -e "${CYAN}Rule hien tai trong ${chain}:${RESET}"
  run_cmd "${IPT[@]}" -L "$chain" -n -v --line-numbers

  while true; do
    rule_num=$(prompt "So rule can xoa trong ${chain} (nhan Enter de huy)" "")
    if [[ -z "$rule_num" ]]; then
      echo -e "${RED}Da huy.${RESET}"
      return 0
    fi
    if [[ "$rule_num" =~ ^[0-9]+$ ]] && [[ "$rule_num" -ge 1 ]]; then
      break
    fi
    echo "So khong hop le."
  done

  confirm=$(prompt "Xac nhan xoa ${chain} dong ${rule_num}? (y/N)" "N")
  case "$confirm" in
    y|Y|yes|YES|s|S|si|SI|c|C|co|CO)
      run_cmd "${IPT[@]}" -D "$chain" "$rule_num"
      echo -e "${GREEN}Da xoa rule.${RESET}"
      ;;
    *)
      echo -e "${RED}Da huy.${RESET}"
      ;;
  esac
}

main_menu
